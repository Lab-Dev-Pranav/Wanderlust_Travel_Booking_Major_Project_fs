<% layout("/layouts/boilerplate") %>

<body>
  <div class="container py-4">
    <h1 class="mb-3 fw-bold">ðŸ’³ My Payments</h1>
    <p class="text-muted">
      Here you can view all your payments â€“
      <span id="live-date" class="fw-semibold"></span>
      <span id="live-time" class="fw-semibold"></span>
    </p>

    <div id="payment-list" class="mt-4">
      <h2 class="h4 fw-bold mb-3">ðŸ“‚ Your Payment History</h2>

      <% if (accountingRecords.length === 0) { %>
        <div class="alert alert-warning text-center rounded-3 shadow-sm">
          No payment records found.
        </div>
      <% } else { %>

        <% 
          // Sort by check-in
          const sortedRecords = accountingRecords.sort(
            (a, b) => new Date(a.booking.checkIn) - new Date(b.booking.checkIn)
          );

          // Calculate total baseAmount
          const totalBaseFee = sortedRecords.reduce((sum, record) => sum + record.baseAmount, 0);
        %>

        <div class="table-responsive shadow-sm rounded-3">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr class="text-center">
                <th>Booking</th>
                <th>Stay Dates</th>
                <th>Guests</th>
                <th>Status</th>
                <th>User</th>
                <th>Amounts</th>
                <th>Payment Date</th>
              </tr>
            </thead>
            <tbody>
              <% for (let record of sortedRecords) { %>
                <tr>
                  <!-- Booking ID -->
                  <td class="text-center small text-muted">
                    <code><%= record.booking._id %></code>
                  </td>

                  <!-- Check-in & Check-out -->
                  <td class="text-center">
                    <div>
                      <span class="fw-bold text-success">
                        <%= new Date(record.booking.checkIn).toDateString() %>
                      </span><br>
                      <small class="text-muted">to</small><br>
                      <span class="fw-bold text-danger">
                        <%= new Date(record.booking.checkOut).toDateString() %>
                      </span>
                    </div>
                  </td>

                  <!-- Guests -->
                  <td class="text-center">
                    ðŸ‘¥ <%= record.booking.people %>
                  </td>

                  <!-- Status -->
                  <td class="text-center">
                    <span class="badge px-3 py-2 rounded-pill 
                      <%= record.booking.status === 'confirmed' ? 'bg-success' : (record.booking.status === 'pending' ? 'bg-primary' : 'bg-secondary') %>">
                      <%= record.booking.status.charAt(0).toUpperCase() + record.booking.status.slice(1) %>
                    </span>
                  </td>

                  <!-- User -->
                  <td>
                    <div class="d-flex align-items-center">
                      <img src="<%= record.user.profilePhoto.url %>" 
                           alt="User Photo" width="36" height="36" 
                           class="rounded-circle me-2 shadow-sm">
                      <div>
                        <span class="fw-semibold"><%= record.user.username %></span><br>
                        <small class="text-muted"><%= record.user.email %></small>
                      </div>
                    </div>
                  </td>

                  <!-- Amounts -->
                  <td>
                    <div class="small">
                      <div>ðŸ’° Base: <span class="fw-semibold">â‚¹<%= record.baseAmount.toLocaleString("en-IN") %></span></div>
                      <div class="text-warning">+ Tax: â‚¹<%= record.taxAmount.toLocaleString("en-IN") %></div>
                      <div class="text-info">+ Fee: â‚¹<%= record.platformAmount.toLocaleString("en-IN") %></div>
                      <div class="fw-bold text-success mt-1">= â‚¹<%= record.totalAmount.toLocaleString("en-IN") %></div>
                    </div>
                  </td>

                  <!-- Payment Date -->
                  <td class="text-center">
                    <%= new Date(record.createdAt).toLocaleDateString("en-IN", { year: "numeric", month: "long", day: "numeric" }) %>
                  </td>
                </tr>
              <% } %>
            </tbody>

            <!-- Totals Row -->
            <tfoot>
              <tr class="table-secondary fw-bold">
                <td colspan="5" class="text-end">Total Base Fee:</td>
                <td colspan="2" class="text-start text-success">
                  â‚¹<%= totalBaseFee.toLocaleString("en-IN") %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Live date/time script -->
  <script>
    function updateDateTime() {
      const now = new Date();
      const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

      document.getElementById('live-date').textContent = now.toLocaleDateString('en-IN', dateOptions) + ' ';
      document.getElementById('live-time').textContent = now.toLocaleTimeString('en-IN', timeOptions);
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>
</body>
